import pygame
import random

pygame.init()

screen = pygame.display.set_mode((800, 600))
pygame.display.set_caption("Mario Game")

background_image = pygame.image.load('map.png').convert()
background_image = pygame.transform.scale(background_image, (800, 600))

lobby_background_image = pygame.image.load('loby.png').convert()
lobby_background_image = pygame.transform.scale(lobby_background_image, (800, 600))

mario_image = pygame.image.load('mario.png').convert()
mario_image.set_colorkey((0, 0, 0))
mario_image = pygame.transform.scale(mario_image, (50, 50))

stand_image = pygame.image.load('stand.png').convert()
stand_image.set_colorkey((0, 0, 0)) 
stand_image = pygame.transform.scale(stand_image, (50, 50))

tinoface_image = pygame.image.load('tinoface.png').convert()
tinoface_image.set_colorkey((0, 0, 0))  
tinoface_image = pygame.transform.scale(tinoface_image, (30, 30))

mario_image_flipped = pygame.transform.flip(mario_image, True, False)
stand_image_flipped = pygame.transform.flip(stand_image, True, False)

ground_image = pygame.image.load('ground.png').convert_alpha()
ground_width, ground_height = ground_image.get_size()

ground_y_position = 500
ground_blocks = [pygame.Rect(x, ground_y_position, ground_width, ground_height) for x in range(0, 800, ground_width)]
block_rect = pygame.Rect(200, ground_y_position - ground_height - 70, ground_width, ground_height)
pipe_rect = pygame.Rect(400, ground_y_position - ground_height - 70, ground_width, ground_height)

scene = "main_menu"
running = True
mario_x, mario_y = 50, ground_y_position - 50
mario_velocity_y = 0
gravity = 0.001
jump_strength = -0.5
on_ground = True
move_speed = 0.1
facing_right = False
moving = False

triangle_falling = False
triangle_x = 0
triangle_y = -50
triangle_speed = 0.3

player_lives = 3
font = pygame.font.SysFont("Arial", 24)

def reset_game():
    global mario_x, mario_y, mario_velocity_y, triangle_falling, triangle_x, triangle_y, player_lives
    mario_x, mario_y = 50, ground_y_position - 50
    mario_velocity_y = 0
    triangle_falling = False
    triangle_x = 0
    triangle_y = -50
    player_lives -= 1

def draw_lobby():
    screen.blit(lobby_background_image, (0, 0))

def draw_game_scene():
    screen.blit(background_image, (0, 0)) 
    if moving:
        current_mario_image = mario_image if facing_right else mario_image_flipped
    else:
        current_mario_image = stand_image if facing_right else stand_image_flipped
    screen.blit(current_mario_image, (mario_x, mario_y))

    for block in ground_blocks:
        screen.blit(ground_image, block.topleft)
    screen.blit(ground_image, block_rect.topleft)
    screen.blit(ground_image, pipe_rect.topleft)

    if triangle_falling:
        pygame.draw.polygon(screen, (255, 0, 0), [(triangle_x, triangle_y),
                                                  (triangle_x + 30, triangle_y + 50),
                                                  (triangle_x - 30, triangle_y + 50)])

    screen.blit(tinoface_image, (10, 10))
    lives_text = font.render(f"x {player_lives}", True, (255, 255, 255))
    screen.blit(lives_text, (50, 10))

def handle_keys():
    global mario_x, mario_y, mario_velocity_y, on_ground, facing_right, moving
    keys = pygame.key.get_pressed()
    moving = False
    if keys[pygame.K_a]:
        mario_x -= move_speed
        facing_right = True
        moving = True
    if keys[pygame.K_d]:
        mario_x += move_speed
        facing_right = False
        moving = True
    if keys[pygame.K_w] and on_ground:
        mario_velocity_y = jump_strength
        on_ground = False
        moving = True

def handle_collisions():
    global mario_y, mario_velocity_y, on_ground
    mario_rect = pygame.Rect(mario_x, mario_y, 50, 50)

    for block in ground_blocks:
        if mario_rect.colliderect(block) and mario_velocity_y > 0:
            mario_y = block.top - 50
            mario_velocity_y = 0
            on_ground = True
            return
    if mario_rect.colliderect(block_rect) and mario_velocity_y > 0:
        mario_y = block_rect.top - 50
        mario_velocity_y = 0
        on_ground = True
    elif mario_rect.colliderect(pipe_rect) and mario_velocity_y > 0:
        mario_y = pipe_rect.top - 50
        mario_velocity_y = 0
        on_ground = True
    elif mario_y >= ground_y_position - 50:
        mario_y = ground_y_position - 50
        mario_velocity_y = 0
        on_ground = True
    else:
        on_ground = False

def handle_triangle():
    global triangle_falling, triangle_y, triangle_x
    mario_rect = pygame.Rect(mario_x, mario_y, 50, 50)
    if triangle_falling:
        triangle_y += triangle_speed
        triangle_rect = pygame.Rect(triangle_x - 30, triangle_y, 60, 50)
        if triangle_rect.colliderect(mario_rect):
            reset_game()
    elif mario_x >= 300 and not triangle_falling:
        triangle_falling = True
        triangle_x = mario_x

while running:
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False
        elif scene == "main_menu" and event.type == pygame.KEYDOWN and event.key == pygame.K_RETURN:
            scene = "main_game"

    if scene == "main_menu":
        draw_lobby()
    elif scene == "main_game":
        handle_keys()
        mario_velocity_y += gravity
        mario_y += mario_velocity_y
        handle_collisions()
        handle_triangle()
        draw_game_scene()

    pygame.display.flip()

pygame.quit()
